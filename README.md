# Elaniin Migration

## Overview
This repository contains an **n8n‑based ETL workflow** that migrates data from the source schema (`alim_*` tables) to the target schema (`srs_*` tables). The migration is orchestrated by a master JSON workflow (`Migrate All SRS Tables (Master Orchestrator).json`) which sequentially executes a series of **Config** and **Migrate** nodes for each table.

## Project Structure
```
/Users/heycsar/Developer/Elaniin/Migration/
├─ srs/
│   ├─ Migrate All SRS Tables (Master Orchestrator).json   # Master workflow
│   ├─ Migrate SRS Table (Parametrized).json               # Sub‑workflow called by each Migrate node
│   └─ … (other JSON node definitions)
├─ .agent/
│   └─ workflows/   # Markdown workflow definitions (optional)
└─ README.md       # <-- this file
```

## Key Concepts
- **Config Nodes** (`n8n-nodes-base.code`): contain a `jsCode` block that defines the source table, destination table, field mappings, value mappings, relationships, batch size, etc.
- **Migrate Nodes** (`n8n-nodes-base.executeWorkflow`): invoke the parametrized sub‑workflow to perform the actual data copy using the configuration generated by the preceding Config node.
- **Sticky Notes**: visual grouping of related tables (e.g., *Gestión de Bodegas*, *Catálogos Base*, *Expedientes*).
- **Connections**: each Config node is wired to its corresponding Migrate node via the `main` output; the Migrate node then connects to the next step in the orchestration.

## Tables Currently Managed
| Source Table | Destination Table | Notes |
|--------------|-------------------|-------|
| `alim_bodega` | `srs_bodega` | Basic catalog with `codigo_bodega`, `estado_bodega` (value mappings). |
| `alim_empresa_persona_bodega` | `srs_empresa_persona_bodega` | Includes special fields `ruta_archivo_constancia_arrendamiento` (VARCHAR(250)) and `registrado` (BOOLEAN DEFAULT false). |
| `alim_certificado_libre_venta` | `srs_certificado_libre_venta` | New table added – fields for CLV code, type, country, emission date, file path, authority, etc.; `tipo_clv` mapped to *NACIONAL* / *EXTERIOR*. |
| `ctl_estado_producto` | `srs_estado_producto` | Simple lookup table (`id`, `nombre`). |
| `alim_empresa` / `alim_persona` | `srs_entidad_experiment` | Unified entity table; `use_db_prefix` set to false. |
| … (other catalog tables such as `ctl_pais`, `ctl_departamento`, `ctl_municipio`, `ctl_tipo_bodega`, etc.) |

## How to Run the Migration
1. **Start n8n** (Docker or local installation). Ensure the workflow files are accessible to n8n.
2. **Open the Master Orchestrator** workflow in the n8n UI.
3. **Execute** the workflow (press the ▶️ button). The workflow will:
   - Generate a master batch ID.
   - Run each Config node to build the migration configuration.
   - Trigger the parametrized sub‑workflow for each table.
4. **Monitor** the execution log and the `sys_migration_audit` table for any errors.
5. **Validate** the target tables in the destination database.

## Adding a New Table
1. **Create a Config node** (type `code`) with the appropriate `jsCode` block (source, destination, field mappings, etc.).
2. **Create a Migrate node** (type `executeWorkflow`) that points to the same sub‑workflow ID (`L5EXIfRXTrEXMkFz`).
3. **Place the nodes** in the appropriate section (e.g., after the Bodega nodes) and add a sticky note if needed.
4. **Add connections** in the `connections` section so that the Config node’s `main` output points to the Migrate node, and the Migrate node points to the next step.
5. **Update the total_tables count** in the master batch node if you want the batch metadata to reflect the new count.

## Common Issues & Debugging
- **JSON syntax errors**: Ensure each object in the array is separated by a single comma. No trailing commas after the last element.
- **Missing field mappings**: Verify that every promoted field has a corresponding entry in `field_mappings` if you need a prefixed code.
- **Value mappings**: Use integer keys for enum conversion; ensure the target column type is compatible (e.g., `VARCHAR`).
- **Connection errors**: Check the `connections` JSON at the bottom of the master file – each node name must match exactly.

## License & Contributions
This project is internal to the Elaniin team. If you need to extend the migration or fix bugs, follow the standard Git workflow (branch, commit, PR) and run the full migration locally before merging.

---
*Generated by the Antigravity AI assistant on 2025‑12‑28.*
